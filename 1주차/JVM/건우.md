# JVM이란 ?

자바의 가상머신으로 하드웨어, 운영체제 등 플랫폼에 상관없이 자바 코드가 돌아가게 해준다.
컴파일러를 통해 자바코드를 바이트코드로 만들어 이 바이트 코드를 jvm이 실행시켜 jvm이 플랫폼이 이해할 수 있는 기계어로 변환시킵니다.

<img width="700" alt="javacompile PNG" src="https://github.com/KKomul2/CS_Study/assets/82176176/a976c1b0-755b-4336-9fbc-b0982327cb30">

## 클래스 로더

컴파일러를 통해 바이트코드가 된 파일은 처음에 class loader에서 실행됩니다.
클래스 로더는 바이트코드인 .class파일을 로드합니다.
클래스 로더는 jre의 일부로 jvm이 클래스를 요청하면 클래스 로더는 클래스 이름으로 클래스를 찾아 런타임에 클래스 정의를 로드합니다.
클래스 로더를 통해 클래스를 찾으면 다음의 과정을 거친다.

<img width="700" alt="classloaderprocess" src="https://github.com/KKomul2/CS_Study/assets/82176176/cd17e35c-5fae-4ea1-b003-ed27ac34924a">

- 로드 : 클래스를 파일에서 가져와 JVM의 메모리에 로드한다.
- 검증(verify) : 읽어 들인 클래스가 자바 언어 명세 및 jvm 명세에 명시된 대로 잘 구성되어 있는지 검사한다. 
- 준비(prepareing) : 클래스가 필요로 하는 메모리를 할당하고, 클래스에 정의된 필드, 메서드, 인터페이스들을 나타내는 데이터 구조를 준비한다.
- 분석(Resolving) : 클래스 상수 풀 내 모든 심볼릭 래퍼런스를 다이렉트 래퍼런스로 변경한다.
- 초기화 :  클래스 변수들을 적절한 값으로 초기화한다. (static 필드 초기화)

## 실행 엔진(Excute Engine)
실행 엔진은 클래스 로더를 통해 런타임 데이터 영역에 배치된 바이트 코드를 명령어 단위로 읽어 실행한다.   
실행 엔진은 바이트 코드를 실제로 JVM 내부에서 기계가 실행할 수 있는 형태로 변경된다.

### 인터프리터
바이트 코드 명령어를 하나씩 읽어서 해석하고 실행한다.
단점 : 명령어를 하나씩 실행하기 하나의 해석을 빠르나 인터프리팅 결과의 실행은 느리다.

### jit(just-in-time)
인터프리터의 단점을 보완하기 위해 도입되어 인터프리터 방식으로 실행하다가 적절한 시점에서 바이트 코드 전체를 컴파일 하여 네이티브 코드로 변경하고, 이후에는 네이티브 코드로 직접 실행하는 방식이다.
네이티브 코드를 실행하는 것이 하나씩 인터프리팅 하는 것보다 바르며 네이티브 코드는 캐시에 보관하기 때문에 한 번 컴파일된 코드는 계속 빠르게 수행되게 된다.
jit 컴파일러가 컴파일하는 과정은 비용이 많이 드는 과정이므로 해당 메서드가 자주 사용되어 일정 수준을 넘기면 컴파일을 수행한다.

## 런타임 데이터 영역
JVM이라는 프로그램이 운영체제 위에서 실행되며 할당받은 메모리 영역이다.

### PC 레지스터 
- 쓰레드가 시작될 때 생성되어 현재 수행 중인 JVM 명령의 주소를 갖는다. 
- PC 레지스터는 CPU 레지스터가 아니다.

### 스택 영역
- jvm 스택은 각 스레드마다 하나씩 존재하며 스레드가 시작할 때 생성된다. 
- 스택 프레임이라는 구조체를 저장하는 스택으로 JVM은 이 스택 프레임을 추가하거나 제거하는 동작을 한다.
- 예외 발생시 printStackTrace() 등의 메서드로 보여주는 StackTrace의 각 라인은 하나의 스택 프레임을 표현한 것이다.
- 메서드가 수행될 때마다 하나의 스택 프레임이 생성되어 해당 스레드의 jvm 스택에 추가되고 메서드가 종료되면 스택 프레임이 제거된다. 
- 스택 프레임은 메서드의 매개변수, 지역변수, 리턴 값, 연산의 결과값 등이 저장된다.
- 스택 영역은 스택 사이즈가 고정되어 있기 때문에 런타임에서 사이즈를 바꿀 수 없다.
- 프로그램 실행 중 메모리의 크기를 초과하면 StackOverFlowError가 발생하게 된다.

### 네이티브 메서드 스택
- 자바 외의 언어로 작성된 네이티브 코드를 위한 스택이다.
- 기계어로 전환된 프로그램을 실행시킨다.

### 메서드 영역
- 모든 스레드가 공유한는 영역으로 jvm이 시작할 때 생성된다.
- JVM이 읽은 각각의 클래스와 인터페이스에 대한 런타임 상수 풀, 필드, 메서드 정보, static 변수, 메서드의 바이트코드 등을 보관한다. 

### 힙 영역
- 힙 영역은 메서드 영역과 함게 모든 쓰레드가 공유한다.
- JVM이 관리하는 프로그램의 동적인 데이터를 저장하는 영역이다.
- 클래스의 인스턴스와 인스턴스, 배열 등이 런타임에 생성되는 참조형 데이터를 저장하는 영역이다.
- 힙 영역은 가비지 컬렉션 대상이다.
- 참조형이기 때문에 스택 영역의 변수 등이 힙 영역의 데이터를 참조한다.

## 가비지 컬렉터
- 자바 가상 머신의 가비지 컬렉터를 사용하여 사용하지 않는 힙 메모리 영역의 데이터를 자동으로 회수한다.
- 자동으로 실행되어 언제 실행되는지는 알 수 없다.
- 개발자가 메모리 관리하는 부담을 줄여준다.
